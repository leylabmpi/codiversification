---
title: "inStrain Analysis"
author: "Liam Fitzstevens"
date: "14.09.21"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dpi = 200)
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(rows.print = 5)
knitr::opts_chunk$set(max.print = 100)

options(bitmapType='cairo')
```


# Introduction

This script generates figure 4A, along with some additional overview information about the strain sharing events.

# Setup

**Paths & Data Loading**

```{r}
comp50 = '/ebio/abt3_projects/HUBIF_metagenomics/code/metagenomes/cophylogeny/instrain/final_for_paper/codiversification/strain_sharing/files/comp50_wmetadata_wNCBI.tsv'
comp <- read_tsv(comp50)
```

**Libraries**

```{r lib load, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(LeyLabRMisc)
```

# Analysis

```{r}
comp50_popANI99999 <- subset(comp50, popANI >= 0.99999)
```

```{r}
# Only 148 of the 118587 comparisons were within MIPs
comp50 %>% count(MIP, sort = TRUE)

# 158; 65 were within MIPs and 93 were between unpaired MIPS or mother-mother/child-child
comp50_popANI99999 %>% count(MIP, sort = TRUE)

# 102 SSE in Gabon; 36 (35%) were within MCPs; 53 (52%) were at town/village; 13 (13%) were at region lvl
comp50_popANI99999 %>% subset(name1_CurrCountry == "Gabon" | name2_CurrCountry == "Gabon") %>% count(Level, sort = TRUE)
# 38 SSE in Vietnam; 11 (29%) were within MCPs; 24 (63%) were at town/village; 1 (3%) was at region lvl 
comp50_popANI99999 %>% subset(name1_CurrCountry == "Vietnam" | name2_CurrCountry == "Vietnam") %>% count(Level, sort = TRUE)
# 18 SSE in Germany; 100% were within MCPs
comp50_popANI99999 %>% subset(name1_CurrCountry == "Germany" | name2_CurrCountry == "Germany") %>% count(Level, sort = TRUE)

comp50_popANI99999 %>% subset(MIP == 0) %>%
                               count(ncbi_taxonomy, name1_SamplingLocation_1, sort = TRUE)
comp50_popANI99999 %>% subset(MIP == 1) %>%
                              count(ncbi_taxonomy, name1_SamplingLocation_1, sort = TRUE)

comp50_popANI99999 %>% subset(MIP == 1) %>%
                               count(name1_SamplingLocation_1, sort = TRUE)

# 36 of the VTEs were in Gabon, 18 in Germany and 11 in Vietnam
top_taxa_VTEs_ncbi <- count(VTEs, ncbi_taxonomy)
top_taxa_comp50_srg <- count(comp50, genome)

phylum_sses <- count(comp50_popANI99999, Phylum, sort = TRUE)
```
Figure 4A
```{r}
#cols_old <- c("p__actinobacteria" = "red", "p__bacteroidetes" = "blue", "p__firmicutes" = "green", "p__proteobacteria" = "orange", "p__spirochaetes" = "pink", "p__tenericutes" = "yellow", "unclassified" = "purple")
cols <- c("p__actinobacteria" = "#660099", "p__bacteroidetes" = "#FF0000", "p__firmicutes" = "#339933", "p__proteobacteria" = "#0000FF", "p__spirochaetes" = "#FF9900", "p__tenericutes" = "#744700", "unclassified" = "#0099FF")

#Interrogating the SSEs
gabon_SS <- comp50 %>%
  subset(name1_CurrCountry == "Gabon" | name2_CurrCountry == "Gabon") %>%
  subset(popANI >= 0.99999) %>%
  arrange(Level_new) %>%
  mutate(Level_new = factor(Level_new, levels=c("MIP", "Town/Village", "Region", "Country", "International"))) %>%
  ggplot(aes(x=Level_new, y=popANI)) +
  labs(title="Gabonese Strain Sharing", x="Level", y = "popANI")+
  geom_boxplot(width=0.3,outlier.shape = NA)+
  scale_colour_manual(values = cols) +#scale_color_brewer(palette="Set1")+
  theme_bw()+
  scale_colour_manual(
      values = cols,
      breaks = c("p__actinobacteria", "p__bacteroidetes", "p__firmicutes", "p__proteobacteria", "p__spirochaetes","p__tenericutes", "unclassified"),
      labels = c("Actinobacteria", "Bacteroidetes", "Firmicutes", "Proteobacteria", "Spirochaetes","Tenericutes", "Unclassified")
    )+
  scale_y_continuous(limit = c(0.9999900, 1.0000000))+
  theme(plot.title = element_text(hjust = 0.5, face="bold"),text = element_text(family = "Helvetica"))+
  theme(axis.text=element_text(size=11),legend.title = element_text(face = "bold"),axis.title.y= element_text(face = "bold"))+
  scale_x_discrete(name = "",
                   label = c("Within\nMCP", "Within\nTown/Village", "Within\nRegion", "Within\nCountry", "Inter-\nNational"),
                   drop = FALSE)+
  geom_jitter(aes(color=Phylum))
ggsave('/ebio/abt3_projects/HUBIF_metagenomics/code/metagenomes/cophylogeny/instrain/final_for_paper/codiversification/strain_sharing/files/gabon_strainsharing.png')

vietnam_SS <- comp50 %>%
  subset(name1_CurrCountry == "Vietnam" | name2_CurrCountry == "Vietnam") %>%
  subset(popANI >= 0.99999) %>%
  arrange(Level_new) %>%
  mutate(Level_new = factor(Level_new, levels=c("MIP", "Town/Village", "Region", "Country", "International"))) %>%
  ggplot(aes(x=Level_new, y=popANI)) +
  labs(title="Vietnamese Strain Sharing", x="Level", y = "popANI")+
  geom_boxplot(width=0.3,outlier.shape = NA)+
  scale_colour_manual(values = cols) +#scale_color_brewer(palette="Set1")+
  theme_bw()+
  scale_colour_manual(
      values = cols,
      breaks = c("p__actinobacteria", "p__bacteroidetes", "p__firmicutes", "p__proteobacteria", "p__spirochaetes","p__tenericutes", "unclassified"),
      labels = c("Actinobacteria", "Bacteroidetes", "Firmicutes", "Proteobacteria", "Spirochaetes","Tenericutes", "Unclassified")
    )+
  scale_y_continuous(limit = c(0.9999900, 1.0000000))+
  theme(plot.title = element_text(hjust = 0.5, face="bold"),text = element_text(family = "Helvetica"))+
  theme(axis.text=element_text(size=11),legend.title = element_text(face = "bold"),axis.title.y= element_text(face = "bold"))+
  scale_x_discrete(name = "",
                   label = c("Within\nMCP", "Within\nTown/Village", "Within\nRegion", "Within\nCountry", "Inter-\nNational"),
                   drop = FALSE)+
  geom_jitter(aes(color=Phylum))
ggsave('/ebio/abt3_projects/HUBIF_metagenomics/code/metagenomes/cophylogeny/instrain/final_for_paper/codiversification/strain_sharing/files/vietnam_strainsharing.png')

germany_SS <- comp50 %>%
  subset(name1_CurrCountry == "Germany" | name2_CurrCountry == "Germany") %>%
  subset(popANI >= 0.99999) %>%
  subset(Level_new == "MIP" | Level_new == "Town/Village" | Level_new == "International") %>%
  arrange(Level_new) %>%
  mutate(Level_new = factor(Level_new, levels=c("MIP", "Town/Village", "International"))) %>%
  ggplot(aes(x=Level_new, y=popANI)) +
  labs(title="German Strain Sharing", x="Level", y = "popANI")+
  geom_boxplot(width=0.3,outlier.shape = NA)+
  scale_colour_manual(values = cols) +#scale_color_brewer(palette="Set1")+
  theme_bw()+
  scale_colour_manual(
      values = cols,
      breaks = c("p__actinobacteria", "p__bacteroidetes", "p__firmicutes", "p__proteobacteria", "p__spirochaetes","p__tenericutes", "unclassified"),
      labels = c("Actinobacteria", "Bacteroidetes", "Firmicutes", "Proteobacteria", "Spirochaetes","Tenericutes", "Unclassified")
    )+
  scale_y_continuous(limit = c(0.9999900, 1.0000000))+
  theme(plot.title = element_text(hjust = 0.5, face="bold"),text = element_text(family = "Helvetica"))+
  theme(axis.text=element_text(size=11),legend.title = element_text(face = "bold"),axis.title.y= element_text(face = "bold"))+
  scale_x_discrete(name = "",
                   label = c("Within\nMCP", "Within\nTown/Village", "Inter-\nNational"),
                   drop = FALSE)+
  geom_jitter(aes(color=Phylum))
ggsave('/ebio/abt3_projects/HUBIF_metagenomics/code/metagenomes/cophylogeny/instrain/final_for_paper/codiversification/strain_sharing/files/germany_strainsharing.png')
```

# Summary

Figure 4A's components are written.

***

# SessionInfo

```{r sessionInfo}
sessionInfo()
```
